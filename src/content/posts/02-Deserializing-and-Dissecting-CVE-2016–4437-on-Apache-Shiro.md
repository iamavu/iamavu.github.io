---
title: Deserializing and Dissecting CVE-2016–4437 on Apache Shiro
published: 2024-03-01
description: 'Root Cause Analysis of CVE-2016-4437'
image: '/public/02-Deserializing-and-Dissecting-CVE-2016–4437-on-Apache-Shiro/shiro.jpg'
tags: [Root Cause Analysis, Vulnerability Research]
category: 'Vulnerability Research'
draft: true 
---

## Deserializing and Dissecting CVE-2016–4437 on Apache Shiro

![shiro](/public/02-Deserializing-and-Dissecting-CVE-2016–4437-on-Apache-Shiro/shiro.jpg)

Just like shiro above, apache shiro is also well, quite dum. Let's see how remembering someone can get you in trouble :0

## 0x01 ~ Setup
Let's get ourselves some shiro, checkout the older and vulnerable version and be ready to pwn

```bash
git clone https://github.com/apache/shiro.git
cd shiro
git checkout shiro-root-1.2.4
```
but before we dissect the vulnerability let me introduce you to a very cool thing called [vulhub](https://github.com/vulhub/vulhub/tree/master/shiro/CVE-2016-4437), pre-built vulnerable docker containers. pretty cool, ey? I know! set up your docker container which we would be using later for exploitation. now it is time to read the code, the fun part, hehe.

## 0x02 ~ Dissection

The file called `AbstractRememberMeManager.java` is quite spicy, let's see why. opening it up, we see this.

```java
/**
     * The following Base64 string was generated by auto-generating an AES Key:
     * <pre>
     * AesCipherService aes = new AesCipherService();
     * byte[] key = aes.generateNewKey().getEncoded();
     * String base64 = Base64.encodeToString(key);
     * </pre>
     * The value of 'base64' was copied-n-pasted here:
     */
    private static final byte[] DEFAULT_CIPHER_KEY_BYTES = Base64.decode("kPH+bIxk5D2deZiIxcaaaA==");
```

hardcoded credentials! don't do that kids, never hard code credentials. looks like it is AES encryption with the key being `kPH+bIxk5D2deZiIxcaaaA==`

Let's have short flashback to what AES is and how it works from this comic. okay now that we understand AES is and even if you don't, that's okay. [crypto](https://www.moserware.com/2009/09/stick-figure-guide-to-advanced.html) is quite cryptic, TL;DR - encryption key is also decryption key

In the same file, we can observe that there is another code snippet which helps a lot

```java
/**
     * Default constructor that initializes a {@link DefaultSerializer} as the {@link #getSerializer() serializer} and
     * an {@link AesCipherService} as the {@link #getCipherService() cipherService}.
     */
    public AbstractRememberMeManager() {
        this.serializer = new DefaultSerializer<PrincipalCollection>();
        this.cipherService = new AesCipherService();
        setCipherKey(DEFAULT_CIPHER_KEY_BYTES);
    }
```

which uses something called `cipherService` which seems to be an interface implemented at `JcaCipherService.java`

